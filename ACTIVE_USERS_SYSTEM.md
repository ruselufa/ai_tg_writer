# üéØ –°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

## ‚úÖ –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

### üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å—é:
- **–¢–∞–π–º–∞—É—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏**: 15 —Å–µ–∫—É–Ω–¥ –¥–ª—è —Ç–µ—Å—Ç–∞ (–ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞ 5 –º–∏–Ω—É—Ç –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —É–¥–∞–ª—è—é—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π**: —Å–æ–æ–±—â–µ–Ω–∏—è, –≥–æ–ª–æ—Å–æ–≤—ã–µ, –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫

### üìä –ì—Ä–∞—Ñ–∏–∫–∏ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö –ø–∞–Ω–µ–ª–µ–π:
- **Active Telegram Users** - –≥—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤–æ –≤—Ä–µ–º–µ–Ω–∏
- **Voice Messages Rate** - —á–∞—Å—Ç–æ—Ç–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **DeepSeek Tokens Rate** - —Å–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- **Payments Rate** - —á–∞—Å—Ç–æ—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º

## üöÄ –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:

### 1. –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏:
```go
// –ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
monitoring.MarkUserActiveGlobal(userID)

// –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏
monitoring.MarkUserActiveGlobal(callback.From.ID)

// –ü—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ
monitoring.MarkUserActiveGlobal(userID)
```

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞:
- –ö–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
- –ï—Å–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 15 —Å–µ–∫—É–Ω–¥ —Å –ø–æ—Å–ª–µ–¥–Ω–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—è–µ—Ç—Å—è
- –ú–µ—Ç—Ä–∏–∫–∞ `telegram_active_users` –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3. –ì—Ä–∞—Ñ–∏–∫–∏ –≤ Grafana:
- –í—Å–µ –ø–∞–Ω–µ–ª–∏ —Ç–µ–ø–µ—Ä—å –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç –∏—Å—Ç–æ—Ä–∏—é –∏–∑–º–µ–Ω–µ–Ω–∏–π
- –ú–æ–∂–Ω–æ –≤–∏–¥–µ—Ç—å –ø–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –õ–µ–≥–∫–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞:

### –ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –Ω–∞ 5 –º–∏–Ω—É—Ç:
```go
// –í cmd/ai_tg_writer/main.go
monitoring.InitActiveUsersManager(5 * time.Minute)
```

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—á–∏—Å—Ç–∫–∏:
```go
// –í internal/monitoring/active_users.go
ticker := time.NewTicker(30 * time.Second) // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
```

## üìà –ß—Ç–æ –≤–∏–¥–Ω–æ –≤ –¥–∞—à–±–æ—Ä–¥–µ:

### –ì—Ä–∞—Ñ–∏–∫ "Active Telegram Users":
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ü–∏–∫–∏ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –º–æ–º–µ–Ω—Ç–∞–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
- –°–ø–∞–¥ —á–µ—Ä–µ–∑ 15 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### –ì—Ä–∞—Ñ–∏–∫ "Voice Messages Rate":
- –ß–∞—Å—Ç–æ—Ç–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (success, error)
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

### –ì—Ä–∞—Ñ–∏–∫ "DeepSeek Tokens Rate":
- –°–∫–æ—Ä–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Ç–∏–ø–∞–º (input, output, total)

### –ì—Ä–∞—Ñ–∏–∫ "Payments Rate":
- –ß–∞—Å—Ç–æ—Ç–∞ –ø–ª–∞—Ç–µ–∂–µ–π
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º (success, failed, pending)
- –†–∞–∑–±–∏–≤–∫–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º (yookassa, prodamus)

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

1. **–†–µ–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å**: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å—á–∏—Ç–∞—é—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞**: –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É–ø—Ä–∞–≤–ª—è—Ç—å —Å—á–µ—Ç—á–∏–∫–∞–º–∏
3. **–ò—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ**: –º–æ–∂–Ω–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–∏–∫–∏ –∏ —Ç—Ä–µ–Ω–¥—ã
4. **–ì–∏–±–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞**: –ª–µ–≥–∫–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–∞–π–º–∞—É—Ç –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏–π
5. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

## üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

```bash
# –ó–∞–ø—É—Å–∫ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
go run ./cmd/ai_tg_writer

# –ü—Ä–æ—Å–º–æ—Ç—Ä –º–µ—Ç—Ä–∏–∫
curl http://localhost:9090/api/v1/query?query=telegram_active_users

# Grafana –¥–∞—à–±–æ—Ä–¥
http://localhost:3000 (admin/admin)
```

## üìä –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ Prometheus:

```promql
# –¢–µ–∫—É—â–∏–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
telegram_active_users

# –ü–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Å
max_over_time(telegram_active_users[1h])

# –°—Ä–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞ –¥–µ–Ω—å
avg_over_time(telegram_active_users[1d])

# –ß–∞—Å—Ç–æ—Ç–∞ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
rate(voice_messages_processed_total[5m])

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ DeepSeek
rate(deepseek_tokens_used_total[5m])
```

–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ

# üöÄ –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üìä –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω—ã **12 –Ω–æ–≤—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–µ—Ç—Ä–∏–∫** –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ AI TG Writer:

### 1. üè¢ –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏
- **–ö–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π** - –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —Ç–∞—Ä–∏—Ñ–∞–º–∏ (free ‚Üí basic ‚Üí premium)
- **Retention Rate** - —É–¥–µ—Ä–∂–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–¥–Ω–µ–≤–Ω–æ–µ, –Ω–µ–¥–µ–ª—å–Ω–æ–µ, –º–µ—Å—è—á–Ω–æ–µ)
- **ARPU** - —Å—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Churn Rate** - –æ—Ç—Ç–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Session Duration** - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º

### 2. üéØ –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
- **Voice Message Success Rate** - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **API Response Time** - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API —Å –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è–º–∏ (50th, 95th)
- **Endpoint Error Rate** - —á–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ –ø–æ —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞–º
- **Queue Length** - –¥–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **Processing Success Rate** - –æ–±—â–∞—è —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 3. üåê –ú–µ—Ç—Ä–∏–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- **External API Latency** - –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö API (Whisper, DeepSeek, YooKassa)
- **External API Success Rate** - –ø—Ä–æ—Ü–µ–Ω—Ç —É—Å–ø–µ—à–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
- **External API Quota Usage** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–æ—Ç —Å–µ—Ä–≤–∏—Å–æ–≤
- **Third-party Service Health** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

### 4. ‚ö° –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- **Goroutine Count** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω
- **Memory Allocations** - –∞–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º
- **GC Pause Duration** - –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø–∞—É–∑ —Å–±–æ—Ä—â–∏–∫–∞ –º—É—Å–æ—Ä–∞
- **Channel Buffer Usage** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤ –∫–∞–Ω–∞–ª–æ–≤
- **Worker Pool Utilization** - –∑–∞–≥—Ä—É–∑–∫–∞ –ø—É–ª–æ–≤ –≤–æ—Ä–∫–µ—Ä–æ–≤

### 5. üë§ –ú–µ—Ç—Ä–∏–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞
- **User Journey Steps** - —à–∞–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—É—Ç–∏
- **Feature Usage** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
- **User Satisfaction Score** - –æ—Ü–µ–Ω–∫–∞ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (1-5)
- **Support Ticket Volume** - –æ–±—ä–µ–º –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
- **User Feedback Sentiment** - —Ç–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–æ–≤ (-1 –¥–æ 1)

## üîß –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –ù–æ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ –≤ `internal/monitoring/metrics.go`:

```go
// –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏
userConversions          // –ö–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
userRetention            // Retention Rate
userARPU                 // ARPU
userChurnRate            // Churn Rate
userSessionDuration      // –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Å—Å–∏–π

// –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
voiceMessageSuccessRate  // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
apiResponseTime          // –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
endpointErrorRate        // –ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫
queueLength              // –î–ª–∏–Ω–∞ –æ—á–µ—Ä–µ–¥–µ–π
processingSuccessRate    // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫–∏

// –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
externalAPILatency       // –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö API
externalAPISuccessRate   // –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö API
externalAPIQuotaUsage    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–æ—Ç
externalServiceHealth    // –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
goroutineCount           // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω
memoryAllocations        // –ê–ª–ª–æ–∫–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
gcPauseDuration          // –ü–∞—É–∑—ã GC
channelBufferUsage       // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±—É—Ñ–µ—Ä–æ–≤
workerPoolUtilization    // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—É–ª–æ–≤

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
userJourneySteps         // –®–∞–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
featureUsage             // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π
userSatisfactionScore    // –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å
supportTicketVolume      // –û–±—Ä–∞—â–µ–Ω–∏—è –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É
userFeedbackSentiment    // –¢–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–∑—ã–≤–æ–≤
```

### –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∑–∞–ø–∏—Å–∏ –º–µ—Ç—Ä–∏–∫:

```go
// –ë–∏–∑–Ω–µ—Å-–º–µ—Ç—Ä–∏–∫–∏
RecordUserConversion(fromTariff, toTariff string)
SetUserRetentionRate(period string, rate float64)
SetUserARPU(period string, arpu float64)
SetUserChurnRate(period string, rate float64)
RecordUserSessionDuration(userTariff string, duration time.Duration)

// –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞
SetVoiceMessageSuccessRate(userTariff string, rate float64)
RecordAPIResponseTime(endpoint, method string, duration time.Duration)
SetEndpointErrorRate(endpoint, method string, rate float64)
SetQueueLength(queueType string, length float64)
SetProcessingSuccessRate(processType string, rate float64)

// –í–Ω–µ—à–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
RecordExternalAPILatency(service, endpoint string, duration time.Duration)
SetExternalAPISuccessRate(service, endpoint string, rate float64)
SetExternalAPIQuotaUsage(service, quotaType string, usage float64)
SetExternalServiceHealth(service string, healthy bool)

// –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
SetGoroutineCount(count int)
RecordMemoryAllocation(sizeClass string, count int)
RecordGCPauseDuration(gcType string, duration time.Duration)
SetChannelBufferUsage(channelName string, usage float64)
SetWorkerPoolUtilization(poolName string, utilization float64)

// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –æ–ø—ã—Ç
RecordUserJourneyStep(step, userTariff string)
RecordFeatureUsage(feature, userTariff string)
SetUserSatisfactionScore(userTariff, feature string, score float64)
RecordSupportTicket(category, priority string)
SetUserFeedbackSentiment(feature, userTariff string, sentiment float64)
```

## üìà –î–∞—à–±–æ—Ä–¥ Grafana

–î–æ–±–∞–≤–ª–µ–Ω—ã **12 –Ω–æ–≤—ã—Ö –ø–∞–Ω–µ–ª–µ–π** –≤ –¥–∞—à–±–æ—Ä–¥:

1. **Business Metrics - Conversions** - –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. **Business Metrics - Retention & ARPU** - —É–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ ARPU
3. **Quality Metrics - Success Rates** - –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏
4. **Quality Metrics - API Response Time** - –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API
5. **External Services - Latency** - –∑–∞–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
6. **External Services - Success Rate & Health** - —É—Å–ø–µ—à–Ω–æ—Å—Ç—å –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
7. **Performance - Goroutines & Memory** - –≥–æ—Ä—É—Ç–∏–Ω—ã –∏ –ø–∞–º—è—Ç—å
8. **Performance - GC & Worker Pools** - GC –∏ –ø—É–ª—ã –≤–æ—Ä–∫–µ—Ä–æ–≤
9. **User Experience - Journey Steps** - —à–∞–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
10. **User Experience - Satisfaction & Feedback** - —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å
11. **Support & Queue Metrics** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∏ –æ—á–µ—Ä–µ–¥–∏
12. **External API Quota Usage** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–≤–æ—Ç

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–û–±–Ω–æ–≤–ª–µ–Ω endpoint `/test-metrics` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤—Å–µ—Ö –Ω–æ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫:

```bash
curl http://localhost:8080/test-metrics
```

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π –º–µ—Ç—Ä–∏–∫.

## üéØ –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤ –∫–æ–¥–µ

### –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

```go
// –í voice_handler.go
monitoring.RecordUserJourneyStep("voice_sent", userTariff)
monitoring.RecordFeatureUsage("voice_processing", userTariff)
monitoring.SetVoiceMessageSuccessRate(userTariff, successRate)

// –í yookassa_handler.go
monitoring.RecordUserConversion("free", "basic")
monitoring.RecordSupportTicket("billing", "medium")
monitoring.SetUserSatisfactionScore("basic", "payment", 4.2)

// –í deepseek_handler.go
monitoring.RecordExternalAPILatency("deepseek", "chat", duration)
monitoring.SetExternalAPISuccessRate("deepseek", "chat", successRate)
monitoring.SetExternalAPIQuotaUsage("deepseek", "tokens", quotaUsage)
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

–í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ Prometheus:
- **Endpoint**: `http://localhost:8080/metrics`
- **Grafana**: `http://localhost:3000` (admin/admin)
- **Prometheus**: `http://localhost:9090`

## üîç –ü–æ–ª–µ–∑–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã Prometheus

```promql
# –ö–æ–Ω–≤–µ—Ä—Å–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
rate(user_conversions_total[5m]) * 60

# Retention Rate
user_retention_rate

# ARPU
user_arpu

# –£—Å–ø–µ—à–Ω–æ—Å—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
voice_message_success_rate

# –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API (95-–π –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—å)
histogram_quantile(0.95, rate(api_response_time_seconds_bucket[5m]))

# –ó–∞–¥–µ—Ä–∂–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö API
histogram_quantile(0.95, rate(external_api_latency_seconds_bucket[5m]))

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Ä—É—Ç–∏–Ω
goroutine_count

# –®–∞–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—É—Ç–∏
rate(user_journey_steps_total[5m]) * 60

# –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_satisfaction_score
```

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Ä–µ–∞–ª—å–Ω—ã–π –∫–æ–¥** - –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤—ã –º–µ—Ç—Ä–∏–∫ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–π —Å–±–æ—Ä —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
3. **–ê–ª–µ—Ä—Ç—ã** - –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö
4. **–ê–Ω–∞–ª–∏—Ç–∏–∫–∞** - —Å–æ–∑–¥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞—à–±–æ—Ä–¥—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
5. **A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **rate()** –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤ –º–∏–Ω—É—Ç—É
- **Histogram** –º–µ—Ç—Ä–∏–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—é—Ç –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª–∏
- **Gauge** –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
- **Counter** –º–µ—Ç—Ä–∏–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç –∑–Ω–∞—á–µ–Ω–∏—è
- –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –∏–º–µ—é—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ª–µ–π–±–ª—ã –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏

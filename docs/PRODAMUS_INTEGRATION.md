# Интеграция с Prodamus

## Обзор

Данная интеграция позволяет принимать платежи через платежную систему Prodamus для подписочной модели с ежемесячной оплатой в размере 999 рублей.

## Настройка

### 1. Переменные окружения

Добавьте в файл `.env`:

```env
PRODAMUS_SECRET_KEY=34b43ca1acbac599ac86f8b403ddede648bbe72f293fa885527c789b4aa33113
```

### 2. Платежная страница

Используется платежная страница: `https://shakirovai.payform.ru`

### 3. URL для уведомлений

- **Успешная оплата**: `https://aiwhisper.ru/payment/success`
- **Неудачная оплата**: `https://aiwhisper.ru/payment/fail`
- **Вебхуки**: `https://aiwhisper.ru/payment/webhook`

## Архитектура

### Компоненты

1. **ProdamusHandler** (`internal/infrastructure/prodamus_payments/`)
   - Создание ссылок на оплату
   - Проверка подписей вебхуков
   - Обработка данных платежей

2. **PaymentHandler** (`api/`)
   - HTTP-обработчики для успешной/неудачной оплаты
   - Обработка вебхуков от Prodamus
   - Обновление статуса пользователей

3. **SubscriptionService** (`internal/service/`)
   - Бизнес-логика подписок
   - Создание подписок
   - Обработка платежей

4. **HTTP-сервер** (`api/server.go`)
   - Запуск на порту 8080
   - Обработка платежных уведомлений

### Поток данных

1. **Создание подписки**:
   - Пользователь нажимает "Купить подписку"
   - Создается ссылка на оплату через Prodamus
   - Пользователь переходит на платежную страницу

2. **Обработка платежа**:
   - Prodamus отправляет вебхук на `/payment/webhook`
   - Проверяется подпись запроса
   - Обновляется тариф пользователя с `free` на `payed`
   - Создается/обновляется запись в таблице `subscriptions`

3. **Возврат пользователя**:
   - При успешной оплате: редирект на `/payment/success`
   - При неудачной оплате: редирект на `/payment/fail`

## База данных

### Таблица `users`
- `tariff`: тариф пользователя (`free` или `payed`)

### Таблица `subscriptions`
- `user_id`: ID пользователя
- `subscription_id`: ID подписки в Prodamus
- `tariff`: тип тарифа
- `status`: статус подписки
- `amount`: сумма платежа
- `next_payment`: дата следующего платежа
- `last_payment`: дата последнего платежа
- `active`: активна ли подписка

## Безопасность

### Проверка подписей

Все вебхуки от Prodamus проверяются с помощью HMAC-SHA256 подписи:

```go
// Проверка подписи
if !h.prodamusHandler.VerifyWebhook(r.Form, signature) {
    http.Error(w, "Неверная подпись", http.StatusUnauthorized)
    return
}
```

### Формат Order ID

Order ID генерируется в формате:
- Подписки: `sub_{userID}_{timestamp}`
- Разовые платежи: `pay_{userID}_{timestamp}`

## Тестирование

### Локальное тестирование

1. Запустите приложение:
```bash
go run ./cmd/ai_tg_writer
```

2. HTTP-сервер будет доступен на порту 8080

3. Для тестирования вебхуков используйте ngrok:
```bash
ngrok http 8080
```

### Проверка интеграции

1. Создайте тестового пользователя
2. Попробуйте создать ссылку на оплату
3. Проверьте обработку вебхуков

## Мониторинг

### Логи

Все операции с платежами логируются:
- Создание ссылок на оплату
- Получение вебхуков
- Обновление статусов пользователей
- Ошибки обработки

### Метрики

Отслеживайте:
- Количество успешных платежей
- Количество неудачных платежей
- Время обработки вебхуков
- Ошибки валидации подписей

## Устранение неполадок

### Частые проблемы

1. **Ошибка "Неверная подпись"**
   - Проверьте правильность `PRODAMUS_SECRET_KEY`
   - Убедитесь, что используется правильная платежная страница

2. **Вебхуки не приходят**
   - Проверьте доступность URL `https://aiwhisper.ru/payment/webhook`
   - Убедитесь, что сервер запущен на порту 8080

3. **Пользователи не обновляются**
   - Проверьте подключение к базе данных
   - Убедитесь, что миграции применены

### Отладка

Включите подробное логирование:
```go
log.SetLevel(log.DebugLevel)
```

## Обновления

### Изменение цены

Для изменения цены подписки обновите:
1. `internal/service/subscription_service.go` - метод `GetAvailableTariffs()`
2. `cmd/ai_tg_writer/main.go` - функция `sendSubscriptionMessage()`
3. `internal/infrastructure/bot/inline_handlers.go` - функция `handleSubscription()`

### Добавление новых тарифов

1. Добавьте новый тариф в `GetAvailableTariffs()`
2. Создайте обработчик для нового тарифа
3. Обновите UI бота 
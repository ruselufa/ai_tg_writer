# ‚è∞ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤ DeepSeek API

## üö® **–ü—Ä–æ–±–ª–µ–º–∞**
```
–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–∞: –æ—à–∏–±–∫–∞ DeepSeek API: –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞: context deadline exceeded (Client.Timeout or context cancellation while reading body)
```

## üîç **–ü—Ä–∏—á–∏–Ω—ã**

1. **–ö–æ—Ä–æ—Ç–∫–∏–π —Ç–∞–π–º–∞—É—Ç HTTP –∫–ª–∏–µ–Ω—Ç–∞** - –≤—Å–µ–≥–æ 60 —Å–µ–∫—É–Ω–¥
2. **DeepSeek API –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–æ–≤ –∑–∞–Ω–∏–º–∞–µ—Ç –≤—Ä–µ–º—è
3. **–°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏** - –º–µ–¥–ª–µ–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
4. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏** - –æ–¥–Ω–∞ –æ—à–∏–±–∫–∞ = –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª

## ‚úÖ **–†–µ—à–µ–Ω–∏–µ**

### 1. **–£–≤–µ–ª–∏—á–µ–Ω–∏–µ —Ç–∞–π–º–∞—É—Ç–æ–≤**

#### **HTTP Client Timeout:**
```go
// –ë—ã–ª–æ
Timeout: 60 * time.Second

// –°—Ç–∞–ª–æ  
Timeout: 300 * time.Second // 5 –º–∏–Ω—É—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤
```

#### **Response Header Timeout:**
```go
// –ë—ã–ª–æ
ResponseHeaderTimeout: 30 * time.Second

// –°—Ç–∞–ª–æ
ResponseHeaderTimeout: 120 * time.Second // 2 –º–∏–Ω—É—Ç—ã –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ Retry –ª–æ–≥–∏–∫–∏**

#### **–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è makeRequest:**
```go
func (dh *DeepSeekHandler) makeRequest(request DeepSeekRequest) (*DeepSeekResponse, error) {
    const maxRetries = 3
    var lastErr error

    for attempt := 1; attempt <= maxRetries; attempt++ {
        log.Printf("üîÑ [DeepSeek] –ü–æ–ø—ã—Ç–∫–∞ %d/%d", attempt, maxRetries)

        response, err := dh.makeSingleRequest(request)
        if err == nil {
            if attempt > 1 {
                log.Printf("‚úÖ [DeepSeek] –£—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ %d –ø–æ–ø—ã—Ç–æ–∫", attempt)
            }
            return response, nil
        }

        lastErr = err
        log.Printf("‚ùå [DeepSeek] –ü–æ–ø—ã—Ç–∫–∞ %d –Ω–µ—É–¥–∞—á–Ω–∞: %v", attempt, err)

        // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –ø–æ–ø—ã—Ç–∫–∞, –∂–¥–µ–º –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º
        if attempt < maxRetries {
            waitTime := time.Duration(attempt) * 2 * time.Second
            log.Printf("‚è≥ [DeepSeek] –ñ–¥–µ–º %v –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...", waitTime)
            time.Sleep(waitTime)
        }
    }

    return nil, fmt.Errorf("–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã, –ø–æ—Å–ª–µ–¥–Ω—è—è –æ—à–∏–±–∫–∞: %v", lastErr)
}
```

#### **–í—ã–¥–µ–ª–µ–Ω–∏–µ makeSingleRequest:**
```go
func (dh *DeepSeekHandler) makeSingleRequest(request DeepSeekRequest) (*DeepSeekResponse, error) {
    // –õ–æ–≥–∏–∫–∞ –æ–¥–Ω–æ–≥–æ HTTP –∑–∞–ø—Ä–æ—Å–∞
}
```

## üîß **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏**

### **–¢–∞–π–º–∞—É—Ç—ã:**
- **HTTP Client**: 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
- **Response Headers**: 120 —Å–µ–∫—É–Ω–¥ (2 –º–∏–Ω—É—Ç—ã)  
- **TLS Handshake**: 10 —Å–µ–∫—É–Ω–¥ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
- **Idle Connection**: 90 —Å–µ–∫—É–Ω–¥ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

### **Retry —Å—Ç—Ä–∞—Ç–µ–≥–∏—è:**
- **–ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫**: 3
- **–í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è**: —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ (2—Å, 4—Å, 8—Å)
- **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –¥–µ—Ç–∞–ª—å–Ω–æ–µ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–∏

### **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:**
```
üîÑ [DeepSeek] –ü–æ–ø—ã—Ç–∫–∞ 1/3
‚ùå [DeepSeek] –ü–æ–ø—ã—Ç–∫–∞ 1 –Ω–µ—É–¥–∞—á–Ω–∞: context deadline exceeded
‚è≥ [DeepSeek] –ñ–¥–µ–º 2s –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º...
üîÑ [DeepSeek] –ü–æ–ø—ã—Ç–∫–∞ 2/3
‚úÖ [DeepSeek] –£—Å–ø–µ—à–Ω–æ –ø–æ—Å–ª–µ 2 –ø–æ–ø—ã—Ç–æ–∫
```

## üß™ **–†–µ–∑—É–ª—å—Ç–∞—Ç**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚ùå –¢–∞–π–º–∞—É—Ç —á–µ—Ä–µ–∑ 60 —Å–µ–∫—É–Ω–¥
- ‚ùå –û–¥–Ω–∞ –æ—à–∏–±–∫–∞ = –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≤–∞–ª
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
- ‚úÖ –î–æ 5 –º–∏–Ω—É—Ç –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å—Ç–∞
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞
- ‚úÖ –ü–æ–≤—ã—à–µ–Ω–Ω–∞—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å API

## üìÅ **–ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**
- `internal/infrastructure/deepseek/deepseek_handler.go`
  - –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã HTTP –∫–ª–∏–µ–Ω—Ç–∞
  - –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞
  - –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

## üéØ **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞**

1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä—ã –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö
2. **–¢–µ—Ä–ø–µ–Ω–∏–µ**: –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫
4. **UX**: –ú–µ–Ω—å—à–µ –æ—à–∏–±–æ–∫ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
5. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –õ—É—á—à–∞—è —Ä–∞–±–æ—Ç–∞ –ø—Ä–∏ –º–µ–¥–ª–µ–Ω–Ω–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏

## üîÆ **–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏**

- –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ API –≤—ã–∑–æ–≤–æ–≤
- –ê–Ω–∞–ª–∏–∑ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–≤–µ—Ç–∞ DeepSeek
- –í–æ–∑–º–æ–∂–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –ø–æ–¥ –Ω–∞–≥—Ä—É–∑–∫—É
- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

## üìù **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

–ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∞–π–º–∞—É—Ç–∞–º–∏ DeepSeek API –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:
- ‚úÖ –£–≤–µ–ª–∏—á–µ–Ω—ã —Ç–∞–π–º–∞—É—Ç—ã –¥–æ —Ä–∞–∑—É–º–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
- ‚úÖ –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- ‚úÖ –ü–æ–≤—ã—à–µ–Ω–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—Å—Ç–æ–≤

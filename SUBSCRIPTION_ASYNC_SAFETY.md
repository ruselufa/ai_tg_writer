# üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç race conditions –∏ –¥—Ä—É–≥–∏—Ö –ø—Ä–æ–±–ª–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

## üîí –ó–∞—â–∏—Ç–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

### 1. **–ò–∑–æ–ª—è—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö**
```go
// –ö–∞–∂–¥–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
for _, sub := range subscriptions {
    go func(subscription *domain.Subscription) {
        // subscription - –ª–æ–∫–∞–ª—å–Ω–∞—è –∫–æ–ø–∏—è, –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –≥–æ—Ä—É—Ç–∏–Ω
    }(sub)
}
```

### 2. **–°–µ–º–∞—Ñ–æ—Ä –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏**
```go
const maxConcurrentPayments = 3      // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
const maxConcurrentRetries = 2       // –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
```

**–ü–æ—á–µ–º—É —Ç–∞–∫–∏–µ –ª–∏–º–∏—Ç—ã:**
- **3 –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞**: YooKassa API –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **2 –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏**: –ú–µ–Ω—å—à–µ –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–∏—Å—Ç–µ–º—É

### 3. **–ê—Ç–æ–º–∞—Ä–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏**
```go
var successCount, errorCount int32
atomic.AddInt32(&successCount, 1)    // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
atomic.AddInt32(&errorCount, 1)      // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ
```

### 4. **WaitGroup –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
```go
var wg sync.WaitGroup
wg.Add(1)                           // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É
defer wg.Done()                     // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
wg.Wait()                           // –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö
```

## üö® –ß—Ç–æ –ù–ï –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å—Å—è

### 1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π**
- –ö–∞–∂–¥—ã–π –ø–ª–∞—Ç–µ–∂ –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `Idempotence-Key`
- YooKassa API –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
- –†–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ = —Ä–∞–∑–Ω—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î

### 2. **Race conditions –≤ –ë–î**
- –ö–∞–∂–¥–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ù–µ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–¥–Ω–æ–π –∑–∞–ø–∏—Å–∏
- –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏

### 3. **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö**
- –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω–æ

## ‚úÖ –ß—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ

### 1. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫**
```go
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A: –ø–æ–¥–ø–∏—Å–∫–∞ ID=1
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B: –ø–æ–¥–ø–∏—Å–∫–∞ ID=2
// –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å C: –ø–æ–¥–ø–∏—Å–∫–∞ ID=3
// –í—Å–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –±–µ–∑–æ–ø–∞—Å–Ω–æ
```

### 2. **HTTP –∑–∞–ø—Ä–æ—Å—ã –∫ YooKassa**
```go
// –ö–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏–º–µ–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π Idempotence-Key
// YooKassa API –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
// –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª–∏–∑–º–∞
```

### 3. **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏**
```go
// –ê—Ç–æ–º–∞—Ä–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—á–µ—Ç—á–∏–∫–æ–≤
// –ú—å—é—Ç–µ–∫—Å—ã –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –¥–∞–Ω–Ω—ã—Ö
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### HTTP Transport –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:
```go
Transport: &http.Transport{
    MaxIdleConns:        100,              // –ü—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
    MaxIdleConnsPerHost: 10,               // –ù–∞ —Ö–æ—Å—Ç
    IdleConnTimeout:     90 * time.Second, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏
    ForceAttemptHTTP2:   true,             // HTTP/2
}
```

### –°–µ–º–∞—Ñ–æ—Ä—ã:
```go
// –û—Å–Ω–æ–≤–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
semaphore := make(chan struct{}, 3)

// –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏  
semaphore := make(chan struct{}, 2)
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:
```go
log.Printf("üí≥ [YooKassa] –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è %d (ID: %d)", 
    subscription.UserID, subscription.ID)
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. **–õ–æ–≥–∏ —Å–µ–º–∞—Ñ–æ—Ä–∞**
```
üí≥ [YooKassa] –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É 5 –ø–æ–¥–ø–∏—Å–æ–∫ (–ª–∏–º–∏—Ç: 3)
üí≥ [YooKassa] –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 123 (ID: 1)
üí≥ [YooKassa] –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 456 (ID: 2)
üí≥ [YooKassa] –ù–∞—á–∏–Ω–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 789 (ID: 3)
```

### 2. **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è**
```
üéâ [YooKassa] –í—Å–µ –ø–ª–∞—Ç–µ–∂–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã. –£—Å–ø–µ—à–Ω–æ: 4, –û—à–∏–±–æ–∫: 1
üéâ [Retry] –í—Å–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã. –£—Å–ø–µ—à–Ω–æ: 1, –û—à–∏–±–æ–∫: 0
```

### 3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–æ—Ä–∫–µ—Ä–∞**
```
üí≥ [YooKassa Monitor] –í–æ—Ä–∫–µ—Ä –ø–æ–¥–ø–∏—Å–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç
```

## ‚ö†Ô∏è –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —Ä–∏—Å–∫–∏ –∏ –∏—Ö –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è

### 1. **–ü–µ—Ä–µ–≥—Ä—É–∑–∫–∞ YooKassa API**
**–†–∏—Å–∫**: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
**–ó–∞—â–∏—Ç–∞**: –°–µ–º–∞—Ñ–æ—Ä —Å –ª–∏–º–∏—Ç–æ–º 3

### 2. **–ò—Å—á–µ—Ä–ø–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏**
**–†–∏—Å–∫**: –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –≥–æ—Ä—É—Ç–∏–Ω
**–ó–∞—â–∏—Ç–∞**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ —Å–µ–º–∞—Ñ–æ—Ä

### 3. **–ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**
**–†–∏—Å–∫**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ UPDATE –æ–ø–µ—Ä–∞—Ü–∏–∏
**–ó–∞—â–∏—Ç–∞**: –†–∞–∑–Ω—ã–µ –∑–∞–ø–∏—Å–∏, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### 1. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏**
```bash
go build ./...
```

### 2. **–ó–∞–ø—É—Å–∫ –≤–æ—Ä–∫–µ—Ä–∞**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –ø—Ä–µ–¥–º–µ—Ç race conditions
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ–º–∞—Ñ–æ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
```

### 3. **–ù–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
```bash
# –°–æ–∑–¥–∞–π—Ç–µ –º–Ω–æ–≥–æ –ø–æ–¥–ø–∏—Å–æ–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ª–∏–º–∏—Ç—ã —Å–æ–±–ª—é–¥–∞—é—Ç—Å—è
# –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
```

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### 1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ —Å–µ–º–∞—Ñ–æ—Ä–∞
- –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 2. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤**
```go
// –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
const maxConcurrentPayments = 2
const maxConcurrentRetries = 1

// –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ (—Ç–µ–∫—É—â–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è)
const maxConcurrentPayments = 3
const maxConcurrentRetries = 2

// –î–ª—è –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏
const maxConcurrentPayments = 5
const maxConcurrentRetries = 3
```

### 3. **–ê–ª–µ—Ä—Ç—ã**
- –ù–∞—Å—Ç—Ä–æ–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ –±–æ–ª—å—à–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –æ—à–∏–±–æ–∫
- –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π
- –°–ª–µ–¥–∏—Ç–µ –∑–∞ –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ YooKassa API

## üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç

**–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏:**
- ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –î–æ 3 –ø–ª–∞—Ç–µ–∂–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø–æ–¥–ø–∏—Å–æ–∫! üöÄ**
